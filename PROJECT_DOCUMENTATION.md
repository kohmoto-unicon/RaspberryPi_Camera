# 統合制御システム 技術仕様書

## 1. プロジェクト概要

このプロジェクトは、Raspberry Piをホストとして、リアルタイムカメラストリーミング、複数のポンプ制御、および高精度ステッピングモーター制御を統合したWebベースの遠隔操作システムです。

Web UIから、カメラ映像の監視、スナップショットの取得、および接続された各種デバイスの制御をリアルタイムで行うことができます。システムのバックエンドはFlask（Python）、モーター制御のファームウェアはArduino（C++）で構築されています。

### 主な機能

-   **リアルタイム映像配信**: Raspberry Pi公式カメラモジュールまたはPCのWebカメラからの映像をMJPEG形式でストリーミングします。
-   **ハイセラポンプ制御**: 2つのシリアルポート（COM18, COM20）を介して、最大6台のハイセラポンプを制御します。
-   **シリンジポンプ制御**: 別のシリアルポート（COM19）を介して、最大6台のシリンジポンプを個別に制御します。
-   **高精度モーター制御**: Arduino上で動作するファームウェアにより、最大3台のステッピングモーターを台形加減速制御付きで精密に操作します。
-   **Webインターフェース**: PCやスマートフォンのブラウザからシステム全体を操作・監視するためのレスポンシブUIを提供します。

## 2. システムアーキテクチャ

本システムは、以下のコンポーネントで構成されています。

```
+-----------------------------+      HTTP      +-----------------+
|      クライアント (ブラウザ)     | <----------> |  Flask Webサーバー |
| (PC / スマートフォン)         |              |     (app.py)    |
+-----------------------------+              +--------+--------+
                                                       |
+------------------------------------------------------+------------------------------------------------------+
| シリアル通信 (pyserial)                                                                                       |
+------------------------+-----------------------------+-----------------------------+------------------------+
                         |                             |                             |
+------------------+   |   +---------------------+   |   +---------------------+   |   +------------------+
| ハイセラポンプ 1-3 |<--+-->| COM18 (RS-232C)     |<--+-->| ハイセラポンプ 4-6 |<--+-->| COM20 (RS-232C)    |
+------------------+       +---------------------+       +---------------------+       +------------------+
                         |                             |                             |
+------------------+   |   +---------------------+   |   +---------------------+   |   +------------------+
| シリンジポンプ 1-6  |<--+-->| COM19 (RS-232C)     |<--+-->| (未使用)            |   |   | (未使用)           |
+------------------+       +---------------------+       +---------------------+       +------------------+
                         |                             |                             |
+------------------+   |   +---------------------+   |   +---------------------+   |   +------------------+
| Arduino (モーター)  |<--+-->| (未接続)            |<--+-->| (未接続)            |   |   | (未接続)           |
+------------------+       +---------------------+       +---------------------+       +------------------+
                         |
+------------------+   |
| カメラ (PiCamera2/CV2) |<--+
+------------------+
```

-   **クライアント**: ユーザーが操作を行うWebブラウザ。サーバーから配信されるHTML/CSS/JavaScriptによってUIが構築され、APIを介してバックエンドと通信します。
-   **Flask Webサーバー (`app.py`)**: システムの中核。クライアントへのUI提供、APIリクエストの処理、および各ハードウェアデバイスとのシリアル通信を担います。
-   **デバイス (ポンプ/カメラ/Arduino)**: 物理的な制御対象。それぞれが個別の通信プロトコルを持ち、Flaskサーバーからのコマンドに応じて動作します。

## 3. 主要ファイルの解説

### 3.1. `app.py` - メインアプリケーション (Flask)

システムのバックエンド全体を管理するPythonスクリプトです。

#### 主要な機能

-   **Webサーバー機能**: Flaskフレームワークを使用し、3つのHTMLページ (`index.html`, `pump_control.html`, `syringe_pump.html`) とAPIエンドポイントを提供します。
-   **実行環境の自動判別**: 起動時に`picamera2`ライブラリの有無をチェックし、Raspberry Pi環境かPC環境かを自動で判別します。
    -   **Raspberry Pi**: `picamera2`ライブラリを使用してカメラを制御します。
    -   **PC**: `OpenCV (cv2.VideoCapture)` を使用してWebカメラを制御します。
-   **デバイス初期化**: サーバー起動時に、カメラと3つのシリアルポート（ハイセラ用x2, シリンジ用x1）の初期化を試みます。
-   **MJPEGストリーミング**: `generate_frames()`関数がカメラからフレームを連続的に取得し、`multipart/x-mixed-replace`形式のHTTPレスポンスとしてクライアントに送信することで、リアルタイム映像を実現しています。
-   **APIエンドポイント**:
    -   `/`: カメラストリーミングのメインページを表示。
    -   `/video_feed`: MJPEGストリームを配信。
    -   `/api/status`: カメラとシリアルポートの初期化状態を返す。
    -   `/api/snapshot`: 現在のカメラフレームをJPEG画像として返す。
    -   `/api/restart_camera`: カメラを再初期化する。
    -   `/api/pump_control`: ハイセラポンプにコマンドを送信する。
    -   `/api/get_current`: ハイセラポンプから電流値を取得する。
    -   `/api/syringe_pump_control`: シリンジポンプにコマンドを送信する。

### 3.2. `command.py` - シリンジポンプ制御モジュール

シリンジポンプとの通信コマンドを生成・送信するためのクラスを定義しています。

-   **`SyringePumpController` クラス**:
    -   `__init__(self, pump_number, serial_port)`: ポンプ番号と、通信に使用する`pyserial`のインスタンスを受け取ります。
    -   `create_command(self, command, address)`: シリンジポンプのプロトコルに従って、送信用のバイトシーケンスを構築します。
        -   **フレーム形式**: `STX(0x02) + ADDR + 0x31 + COMMAND + ETX(0x03) + Checksum`
        -   **Checksum**: STXからETXまで、全てのバイトのXOR（排他的論理和）です。
    -   `send_command(self, command, address)`: 生成したコマンドをシリアルポートに書き込みます。

### 3.3. `templates/index.html` - フロントエンド

メインのカメラストリーミングページのUIを定義するHTMLファイルです。

-   **構造**:
    -   ヘッダー、ナビゲーションリンク、システム状態表示エリア、ビデオコンテナ、操作ボタン、スナップショット表示エリアで構成されます。
    -   CSSは`<style>`タグ内に直接記述されており、モダンでレスポンシブなデザインを提供します。
-   **JavaScriptによる非同期通信**:
    -   `fetch` APIを使用して、バックエンドのAPIエンドポイントを呼び出します。
    -   **状態確認**: `checkStatus()`関数が定期的に`/api/status`を呼び出し、カメラの状態をUIに反映します。
    -   **スナップショット**: `takeSnapshot()`関数が`/api/snapshot`を呼び出し、取得した画像をページ上に表示・ダウンロード可能にします。
    -   **カメラ再起動**: `restartCamera()`関数が`/api/restart_camera`を呼び出します。
    -   ユーザー操作に対してローディング表示やエラーメッセージを動的に表示する機能も実装されています。

### 3.4. `arduino/kousoku5/kousoku5.ino` - ステッピングモーター制御ファームウェア

Arduino Mega (または互換機) で動作する、最大3台のステッピングモーターを制御するためのファームウェアです。**`app.py`のハイセラポンプ制御とは異なる、独立したコンポーネントです。**

-   **高度なモーター制御**:
    -   **タイマー割り込み駆動**: 3つのハードウェアタイマー（TIMER3, 4, 5）を使用し、マイクロ秒単位で正確なステップパルスを生成します。これにより、メインループの処理に影響されずに安定したモーター駆動が可能です。
    -   **台形加減速制御**: `useTrapezoid`フラグが有効な場合、モーターの開始・停止時に滑らかな加減速を行います。目標速度や移動ステップ数から、加速・等速・減速の各フェーズを自動で計算し、滑らかな動作を実現します。
    -   **動的な速度変更**: モーター動作中にも、シリアルコマンドで目標速度をリアルタイムに変更できます。
-   **センサー監視**:
    -   **漏液センサー**: 3つのデジタルピンで漏液を監視します。
    -   **電流センサー**: 3つのアナログピンでモーターの消費電流を監視し、移動平均を計算して脱調検知などに利用できます。
-   **シリアル通信**:
    -   `app.py`のハイセラポンプと同様の`STX(0x02)`で始まる11バイトの固定長コマンドを受け付けます。
    -   `C`コマンドで要求されると、計算済みの平均電流値をシリアルで返信します。

## 4. 通信プロトコル

### 4.1. ハイセラポンプ / Arduino (`app.py` / `kousoku5.ino`)

両者は類似した11バイトの固定長コマンド形式を使用します。

-   **送信フォーマット**:
    -   `[0]` STX (0x02)
    -   `[1]` ポンプ番号 (`'1'`-`'3'`)
    -   `[2]` アクションコマンド (ASCII文字, e.g., `'M'`, `'S'`)
    -   `[3-8]` 値 (ASCII数字6桁, e.g., `"001000"`)
    -   `[9]` チェックサム (byte[1]からbyte[8]までのXOR)
    -   `[10]` ETX (0x03)

### 4.2. シリンジポンプ (`command.py`)

-   **送信フォーマット**:
    -   `[0]` STX (0x02)
    -   `[1]` ポンプアドレス (ASCII文字, `'1'`-`'6'`)
    -   `[2]` 固定値 (0x31)
    -   `[...]` コマンド文字列 (ASCII, 可変長, e.g., `"ZR"`, `"D3000"`)
    -   `[...]` ETX (0x03)
    -   `[...]` チェックサム (STXからETXまでの全バイトのXOR)

## 5. セットアップと実行方法

基本的な手順は`README.md`に記載されています。

1.  **ハードウェア接続**: Raspberry Piにカメラ、各種ポンプ（対応するシリアル変換器経由）、Arduinoを接続します。
2.  **依存関係インストール**: `requirements.txt` に基づいてPythonライブラリをインストールします。
    ```bash
    pip install -r requirements.txt
    ```
3.  **ファームウェア書き込み**: `arduino/kousoku5/kousoku5.ino` をArduino IDEで開き、Arduino Megaに書き込みます。
4.  **サーバー起動**:
    ```bash
    python app.py --port 5000
    ```
    -   必要に応じて、`--host`や各シリアルポートの引数を指定できます。

## 6. 注意点と考察

-   **Arduinoとの連携**: `解説.txt`には「Arduinoによるステッピングモータ制御」と記載がありますが、現状の`app.py`には`kousoku5.ino`と直接通信するためのAPIエンドポイントやロジックは実装されていません。ハイセラポンプ用の`/api/pump_control`が、Arduinoのプロトコルと互換性があるため、このAPIを流用してArduinoを制御することを想定している可能性があります。
-   **COMポート**: シリアルポートの指定がWindows環境の`COM`ポート名でハードコードされています。Linux環境（Raspberry Pi OSなど）で実行する場合は、`/dev/ttyUSB0`のようなデバイス名に修正するか、起動時引数で指定する必要があります。
-   **エラーハンドリング**: シリアル通信部分のエラーハンドリングは基本的なものです。本番環境で利用する場合は、より堅牢な再接続処理やロギング機構の実装が望まれます。
-   **セキュリティ**: 現状では認証機能が実装されていません。インターネット経由でアクセス可能な環境に設置する場合、Basic認証やトークンベースの認証など、何らかのセキュリティ対策を講じる必要があります。

---
このドキュメントは、プロジェクトのソースコードを静的に分析した結果に基づいて作成されました。
