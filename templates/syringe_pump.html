<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚·ãƒªãƒ³ã‚¸ãƒãƒ³ãƒ—åˆ¶å¾¡</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; margin: 0; }
        .container { max-width: 1200px; margin: 0 auto; background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: #fff; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin: 0 0 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .content { padding: 30px; }
        .nav-links { text-align: center; margin-bottom: 20px; }
        .nav-links a { display: inline-block; padding: 10px 20px; margin: 0 10px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; text-decoration: none; border-radius: 25px; font-weight: 600; transition: all 0.3s ease; }
        .nav-links a:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4); }
        .card { background: #fff; border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .status { margin-bottom: 20px; }
        .status h3 { margin: 0; }
        .status p { margin: 0; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; background: #28a745; }
        .pump-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .pump-box { border: 2px solid #e0e0e0; padding: 20px; border-radius: 15px; background: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: all 0.3s ease; }
        .pump-box:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        .pump-box h2 { margin: 0 0 15px; color: #333; font-size: 1.5em; text-align: center; }
        .control-group { margin-bottom: 15px; }
        .input-group { display: flex; align-items: center; gap: 10px; flex-wrap: nowrap; }
        .control-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        select { width: 100%; padding: 10px 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; }
        .input-group select { width: auto; min-width: 72px; }
        select:focus { outline: none; border-color: #4facfe; }

        .btn { white-space: nowrap; }
        .muted { color: #666; }
        .placeholder { padding: 30px; text-align: center; color: #666; border: 2px dashed #cfd8dc; border-radius: 12px; background: #fafbfc; }
        .actions { margin-top: 20px; text-align: center; }
        .btn { padding: 12px 24px; border: none; border-radius: 25px; font-size: 1em; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-block; transition: all 0.3s ease; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
        
        /* å„ãƒœã‚¿ãƒ³ã‚¿ã‚¤ãƒ—åˆ¥ã®ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .btn-initialize { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: #fff; }
        .btn-initialize:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 123, 255, 0.4); }
        
        .btn-up { background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); color: #fff; }
        .btn-up:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4); }
        
        .btn-down { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: #fff; }
        .btn-down:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(23, 162, 184, 0.4); }
        
        .btn-loop { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: #fff; }
        .btn-loop:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4); }
        
        .btn-stop { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: #fff; }
        .btn-stop:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(220, 53, 69, 0.4); }
        
        .btn-status { background: linear-gradient(135deg, #6f42c1 0%, #5a2d91 100%); color: #fff; }
        .btn-status:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(111, 66, 193, 0.4); }
        .pump-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .pump-box { border: 2px solid #e0e0e0; padding: 20px; border-radius: 15px; background: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: all 0.3s ease; }
        .pump-box:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        .pump-box h2 { margin: 0 0 15px; color: #333; font-size: 1.5em; text-align: center; }
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        select { width: 100%; padding: 10px 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; }
        select:focus { outline: none; border-color: #4facfe; }
    </style>
    <script>
        // ã‚³ãƒãƒ³ãƒ‰ãƒã‚¤ãƒˆã‚’è¡¨ç¤ºç”¨ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹é–¢æ•°
        function formatCommandBytes(commandBytes) {
            if (!commandBytes || commandBytes.length === 0) return '';
            
            let formatted = '';
            for (let i = 0; i < commandBytes.length; i++) {
                const byte = commandBytes[i];
                if (byte === 0x02) {
                    formatted += 'STX ';
                } else if (byte === 0x03) {
                    formatted += 'ETX ';
                } else if (byte >= 32 && byte <= 126) {
                    // è¡¨ç¤ºå¯èƒ½ãªASCIIæ–‡å­—
                    formatted += String.fromCharCode(byte) + ' ';
                } else {
                    // ãã®ä»–ã®ãƒã‚¤ãƒˆã¯16é€²æ•°ã§è¡¨ç¤º
                    formatted += `0x${byte.toString(16).padStart(2, '0').toUpperCase()} `;
                }
            }
            return formatted.trim();
        }

        async function checkStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                const syringeOnline = !!data.syringe_serial_initialized;
                const syringeIndicator = document.getElementById('syringeStatus');
                const syringeText = document.getElementById('syringeStatusText');
                if (syringeOnline) {
                    syringeIndicator.style.background = '#28a745';
                    syringeText.textContent = 'USB2ï¼ˆã‚·ãƒªãƒ³ã‚¸ãƒãƒ³ãƒ—ï¼‰: ã‚ªãƒ³ãƒ©ã‚¤ãƒ³';
                } else {
                    syringeIndicator.style.background = '#dc3545';
                    syringeText.textContent = 'USB2ï¼ˆã‚·ãƒªãƒ³ã‚¸ãƒãƒ³ãƒ—ï¼‰: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³';
                }
            } catch (e) {
                console.error('çŠ¶æ…‹ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ', e);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // çŠ¶æ…‹è¡¨ç¤ºã®å®šæœŸæ›´æ–°
            checkStatus();
            setInterval(checkStatus, 30000);

            // 6å°åˆ†ã®ã‚¢ãƒ‰ãƒ¬ã‚¹åˆæœŸåŒ–ï¼ˆ1..6 ã‚’ãƒ¦ãƒ‹ãƒ¼ã‚¯ã«å‰²å½“ï¼‰ï¼‹ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
            const defaultAddresses = {1:1, 2:2, 3:3, 4:4, 5:5, 6:6};
            for (let pump = 1; pump <= 6; pump++) {
                const select = document.getElementById(`addr${pump}`);
                if (!select) continue;
                const key = `syringe_addr_p${pump}`;
                const saved = localStorage.getItem(key);
                let initial = saved ? Number(saved) : defaultAddresses[pump];
                if (initial < 1 || initial > 6 || Number.isNaN(initial)) initial = defaultAddresses[pump];
                select.value = String(initial);
                if (!saved) localStorage.setItem(key, String(initial));
                select.addEventListener('change', () => {
                    localStorage.setItem(key, select.value);
                });
                // åˆæœŸåŒ–ãƒœã‚¿ãƒ³
                const initBtn = document.getElementById(`initBtn${pump}`);
                if (initBtn) {
                    initBtn.addEventListener('click', async () => {
                        try {
                            initBtn.disabled = true;
                            initBtn.textContent = 'é€ä¿¡ä¸­...';
                            
                            const address = document.getElementById(`addr${pump}`).value;
                            const response = await fetch(`/api/syringe_pump_control?pump=${pump}&action=initialize&address=${address}`);
                            const data = await response.json();
                            
                            // æˆå¦ã«é–¢ã‚ã‚‰ãšã€ã‚³ãƒãƒ³ãƒ‰å†…å®¹ãŒè¿”ã£ã¦ããŸã‚‰è¡¨ç¤º
                            if (data.command_bytes && data.command_bytes.length > 0) {
                                const commandDisplay = document.getElementById(`commandDisplay${pump}`);
                                if (commandDisplay) {
                                    const commandBytes = new Uint8Array(data.command_bytes);
                                    commandDisplay.value = formatCommandBytes(commandBytes);
                                }
                            }
                            if (!data.success) {
                                console.error(`åˆæœŸåŒ–ã‚³ãƒãƒ³ãƒ‰é€ä¿¡å¤±æ•—: ${data.message}`);
                            }
                        } catch (error) {
                            console.error('åˆæœŸåŒ–ã‚³ãƒãƒ³ãƒ‰é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                        } finally {
                            initBtn.disabled = false;
                            initBtn.textContent = 'åˆæœŸåŒ–';
                        }
                    });
                }
                
                // ä¸Šç§»å‹•ã‚¹ãƒ†ãƒƒãƒ—æ•°ã®ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›å‡¦ç†
                const stepsSelect = document.getElementById(`steps${pump}`);
                if (stepsSelect) {
                    stepsSelect.addEventListener('change', () => {
                        if (stepsSelect.value === 'custom') {
                            const customValue = prompt('ã‚¹ãƒ†ãƒƒãƒ—æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
                            if (customValue !== null && customValue.trim() !== '') {
                                const numValue = parseInt(customValue);
                                if (!isNaN(numValue) && numValue > 0) {
                                    // ã‚«ã‚¹ã‚¿ãƒ å€¤ã‚’æ–°ã—ã„optionã¨ã—ã¦è¿½åŠ 
                                    const newOption = document.createElement('option');
                                    newOption.value = customValue;
                                    newOption.textContent = customValue;
                                    stepsSelect.insertBefore(newOption, stepsSelect.lastElementChild);
                                    stepsSelect.value = customValue;
                                } else {
                                    alert('æœ‰åŠ¹ãªæ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                                    stepsSelect.value = '3000'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«æˆ»ã™
                                }
                            } else {
                                stepsSelect.value = '3000'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«æˆ»ã™
                            }
                        }
                    });
                }
                
                // ä¸‹ç§»å‹•ã‚¹ãƒ†ãƒƒãƒ—æ•°ã®ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›å‡¦ç†
                const downStepsSelect = document.getElementById(`downSteps${pump}`);
                if (downStepsSelect) {
                    downStepsSelect.addEventListener('change', () => {
                        if (downStepsSelect.value === 'custom') {
                            const customValue = prompt('ã‚¹ãƒ†ãƒƒãƒ—æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
                            if (customValue !== null && customValue.trim() !== '') {
                                const numValue = parseInt(customValue);
                                if (!isNaN(numValue) && numValue > 0) {
                                    // ã‚«ã‚¹ã‚¿ãƒ å€¤ã‚’æ–°ã—ã„optionã¨ã—ã¦è¿½åŠ 
                                    const newOption = document.createElement('option');
                                    newOption.value = customValue;
                                    newOption.textContent = customValue;
                                    downStepsSelect.insertBefore(newOption, downStepsSelect.lastElementChild);
                                    downStepsSelect.value = customValue;
                                } else {
                                    alert('æœ‰åŠ¹ãªæ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                                    downStepsSelect.value = '3000'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«æˆ»ã™
                                }
                            } else {
                                downStepsSelect.value = '3000'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«æˆ»ã™
                            }
                        }
                    });
                }
                
                // ãƒ«ãƒ¼ãƒ—æ•°ã®ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›å‡¦ç†
                const loopCountSelect = document.getElementById(`loopCount${pump}`);
                if (loopCountSelect) {
                    loopCountSelect.addEventListener('change', () => {
                        if (loopCountSelect.value === 'custom') {
                            const customValue = prompt('ãƒ«ãƒ¼ãƒ—æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
                            if (customValue !== null && customValue.trim() !== '') {
                                const numValue = parseInt(customValue);
                                if (!isNaN(numValue) && numValue >= 0) {
                                    // ã‚«ã‚¹ã‚¿ãƒ å€¤ã‚’æ–°ã—ã„optionã¨ã—ã¦è¿½åŠ 
                                    const newOption = document.createElement('option');
                                    newOption.value = customValue;
                                    newOption.textContent = customValue;
                                    loopCountSelect.insertBefore(newOption, loopCountSelect.lastElementChild);
                                    loopCountSelect.value = customValue;
                                } else {
                                    alert('æœ‰åŠ¹ãªæ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ0ä»¥ä¸Šã®æ•´æ•°ï¼‰');
                                    loopCountSelect.value = '0'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«æˆ»ã™
                                }
                            } else {
                                loopCountSelect.value = '0'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«æˆ»ã™
                            }
                        }
                    });
                }
                
                // ä¸Šç§»å‹•ãƒœã‚¿ãƒ³
                const upBtn = document.getElementById(`upBtn${pump}`);
                if (upBtn) {
                    upBtn.addEventListener('click', async () => {
                        try {
                            upBtn.disabled = true;
                            upBtn.textContent = 'é€ä¿¡ä¸­...';
                            
                            const steps = document.getElementById(`steps${pump}`).value;
                            const address = document.getElementById(`addr${pump}`).value;
                            const response = await fetch(`/api/syringe_pump_control?pump=${pump}&action=move_up&steps=${steps}&address=${address}`);
                            const data = await response.json();
                            
                            // æˆå¦ã«é–¢ã‚ã‚‰ãšã€ã‚³ãƒãƒ³ãƒ‰å†…å®¹ãŒè¿”ã£ã¦ããŸã‚‰è¡¨ç¤º
                            if (data.command_bytes && data.command_bytes.length > 0) {
                                const commandDisplay = document.getElementById(`commandDisplay${pump}`);
                                if (commandDisplay) {
                                    const commandBytes = new Uint8Array(data.command_bytes);
                                    commandDisplay.value = formatCommandBytes(commandBytes);
                                }
                            }
                            if (!data.success) {
                                console.error(`ä¸Šç§»å‹•ã‚³ãƒãƒ³ãƒ‰é€ä¿¡å¤±æ•—: ${data.message}`);
                            }
                        } catch (error) {
                            console.error('ä¸Šç§»å‹•ã‚³ãƒãƒ³ãƒ‰é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                        } finally {
                            upBtn.disabled = false;
                            upBtn.textContent = 'ä¸Šç§»å‹•';
                        }
                    });
                }
                
                // ä¸‹ç§»å‹•ãƒœã‚¿ãƒ³
                const downBtn = document.getElementById(`downBtn${pump}`);
                if (downBtn) {
                    downBtn.addEventListener('click', async () => {
                        try {
                            downBtn.disabled = true;
                            downBtn.textContent = 'é€ä¿¡ä¸­...';
                            
                            const steps = document.getElementById(`downSteps${pump}`).value;
                            const address = document.getElementById(`addr${pump}`).value;
                            const response = await fetch(`/api/syringe_pump_control?pump=${pump}&action=move_down&steps=${steps}&address=${address}`);
                            const data = await response.json();
                            
                            // æˆå¦ã«é–¢ã‚ã‚‰ãšã€ã‚³ãƒãƒ³ãƒ‰å†…å®¹ãŒè¿”ã£ã¦ããŸã‚‰è¡¨ç¤º
                            if (data.command_bytes && data.command_bytes.length > 0) {
                                const commandDisplay = document.getElementById(`commandDisplay${pump}`);
                                if (commandDisplay) {
                                    const commandBytes = new Uint8Array(data.command_bytes);
                                    commandDisplay.value = formatCommandBytes(commandBytes);
                                }
                            }
                            if (!data.success) {
                                console.error(`ä¸‹ç§»å‹•ã‚³ãƒãƒ³ãƒ‰é€ä¿¡å¤±æ•—: ${data.message}`);
                            }
                        } catch (error) {
                            console.error('ä¸‹ç§»å‹•ã‚³ãƒãƒ³ãƒ‰é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                        } finally {
                            downBtn.disabled = false;
                            downBtn.textContent = 'ä¸‹ç§»å‹•';
                        }
                    });
                }
                
                // åœæ­¢ãƒœã‚¿ãƒ³
                const stopBtn = document.getElementById(`stopBtn${pump}`);
                if (stopBtn) {
                    stopBtn.addEventListener('click', async () => {
                        try {
                            stopBtn.disabled = true;
                            stopBtn.textContent = 'é€ä¿¡ä¸­...';
                            
                            const address = document.getElementById(`addr${pump}`).value;
                            const response = await fetch(`/api/syringe_pump_control?pump=${pump}&action=stop&address=${address}`);
                            const data = await response.json();
                            
                            // æˆå¦ã«é–¢ã‚ã‚‰ãšã€ã‚³ãƒãƒ³ãƒ‰å†…å®¹ãŒè¿”ã£ã¦ããŸã‚‰è¡¨ç¤º
                            if (data.command_bytes && data.command_bytes.length > 0) {
                                const commandDisplay = document.getElementById(`commandDisplay${pump}`);
                                if (commandDisplay) {
                                    const commandBytes = new Uint8Array(data.command_bytes);
                                    commandDisplay.value = formatCommandBytes(commandBytes);
                                }
                            }
                            if (!data.success) {
                                console.error(`åœæ­¢ã‚³ãƒãƒ³ãƒ‰é€ä¿¡å¤±æ•—: ${data.message}`);
                            }
                        } catch (error) {
                            console.error('åœæ­¢ã‚³ãƒãƒ³ãƒ‰é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                        } finally {
                            stopBtn.disabled = false;
                            stopBtn.textContent = 'åœæ­¢';
                        }
                    });
                }
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒœã‚¿ãƒ³
                const statusBtn = document.getElementById(`statusBtn${pump}`);
                if (statusBtn) {
                    statusBtn.addEventListener('click', async () => {
                        try {
                            statusBtn.disabled = true;
                            statusBtn.textContent = 'é€ä¿¡ä¸­...';
                            
                            const address = document.getElementById(`addr${pump}`).value;
                            const response = await fetch(`/api/syringe_pump_control?pump=${pump}&action=qr&address=${address}`);
                            const data = await response.json();
                            
                            // æˆå¦ã«é–¢ã‚ã‚‰ãšã€ã‚³ãƒãƒ³ãƒ‰å†…å®¹ãŒè¿”ã£ã¦ããŸã‚‰è¡¨ç¤º
                            if (data.command_bytes && data.command_bytes.length > 0) {
                                const commandDisplay = document.getElementById(`commandDisplay${pump}`);
                                if (commandDisplay) {
                                    const commandBytes = new Uint8Array(data.command_bytes);
                                    commandDisplay.value = formatCommandBytes(commandBytes);
                                }
                            }
                            if (!data.success) {
                                console.error(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªã‚³ãƒãƒ³ãƒ‰é€ä¿¡å¤±æ•—: ${data.message}`);
                            }
                        } catch (error) {
                            console.error('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªã‚³ãƒãƒ³ãƒ‰é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                        } finally {
                            statusBtn.disabled = false;
                            statusBtn.textContent = 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹';
                        }
                        });
                }
                
                // ãƒ«ãƒ¼ãƒ—ãƒœã‚¿ãƒ³
                const loopBtn = document.getElementById(`loopBtn${pump}`);
                if (loopBtn) {
                    loopBtn.addEventListener('click', async () => {
                        try {
                            loopBtn.disabled = true;
                            loopBtn.textContent = 'é€ä¿¡ä¸­...';
                            
                            const loopCount = document.getElementById(`loopCount${pump}`).value;
                            const downSteps = document.getElementById(`downSteps${pump}`).value;
                            const upSteps = document.getElementById(`steps${pump}`).value;
                            const address = document.getElementById(`addr${pump}`).value;
                            const response = await fetch(`/api/syringe_pump_control?pump=${pump}&action=loop&loopCount=${loopCount}&downSteps=${downSteps}&steps=${upSteps}&address=${address}`);
                            const data = await response.json();
                            
                            // æˆå¦ã«é–¢ã‚ã‚‰ãšã€ã‚³ãƒãƒ³ãƒ‰å†…å®¹ãŒè¿”ã£ã¦ããŸã‚‰è¡¨ç¤º
                            if (data.command_bytes && data.command_bytes.length > 0) {
                                const commandDisplay = document.getElementById(`commandDisplay${pump}`);
                                if (commandDisplay) {
                                    const commandBytes = new Uint8Array(data.command_bytes);
                                    commandDisplay.value = formatCommandBytes(commandBytes);
                                }
                            }
                            if (!data.success) {
                                console.error(`ãƒ«ãƒ¼ãƒ—ã‚³ãƒãƒ³ãƒ‰é€ä¿¡å¤±æ•—: ${data.message}`);
                            }
                        } catch (error) {
                            console.error('ãƒ«ãƒ¼ãƒ—ã‚³ãƒãƒ³ãƒ‰é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                        } finally {
                            loopBtn.disabled = false;
                            loopBtn.textContent = 'ãƒ«ãƒ¼ãƒ—';
                        }
                    });
                }
            }
        });
    </script>
    </head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’‰ ã‚·ãƒªãƒ³ã‚¸ãƒãƒ³ãƒ—åˆ¶å¾¡</h1>
        </div>

        <div class="content">
            <div class="nav-links">
                <a href="/">ğŸ“¹ ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°</a>
                <a href="/pump_control">ğŸ”§ ãƒã‚¤ã‚»ãƒ©ãƒãƒ³ãƒ—åˆ¶å¾¡</a>
                <a href="/syringe_pump">ğŸ’‰ ã‚·ãƒªãƒ³ã‚¸ãƒãƒ³ãƒ—åˆ¶å¾¡</a>
            </div>

            <div class="status">
                <h3>ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h3>
                <p>
                    <span class="status-indicator" id="syringeStatus"></span>
                    <span id="syringeStatusText">COM19ï¼ˆã‚·ãƒªãƒ³ã‚¸ãƒãƒ³ãƒ—ï¼‰: ç¢ºèªä¸­...</span>
                </p>
            </div>

            <div class="pump-grid">
                {% for pump in range(1,7) %}
                <div class="pump-box">
                    <h2>ã‚·ãƒªãƒ³ã‚¸ãƒãƒ³ãƒ— {{ pump }}</h2>
                    <div class="control-group">
                        <label for="addr{{ pump }}">ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <div class="input-group">
                        <select id="addr{{ pump }}" data-pump="{{ pump }}">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                        </select>
                        <button type="button" class="btn btn-initialize" id="initBtn{{ pump }}" data-pump="{{ pump }}">åˆæœŸåŒ–</button>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <div class="input-group">
                            <select id="steps{{ pump }}" data-pump="{{ pump }}" style="width: 100px; padding: 10px 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                                <option value="1000">1000</option>
                                <option value="2000">2000</option>
                                <option value="3000" selected>3000</option>
                                <option value="4000">4000</option>
                                <option value="5000">5000</option>
                                <option value="6000">6000</option>
                                <option value="custom">ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›...</option>
                            </select>
                            <button type="button" class="btn btn-up" id="upBtn{{ pump }}" data-pump="{{ pump }}">ä¸Šç§»å‹•</button>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <div class="input-group">
                            <select id="downSteps{{ pump }}" data-pump="{{ pump }}" style="width: 100px; padding: 10px 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                                <option value="1000">1000</option>
                                <option value="2000">2000</option>
                                <option value="3000" selected>3000</option>
                                <option value="4000">4000</option>
                                <option value="5000">5000</option>
                                <option value="6000">6000</option>
                                <option value="custom">ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›...</option>
                            </select>
                            <button type="button" class="btn btn-down" id="downBtn{{ pump }}" data-pump="{{ pump }}">ä¸‹ç§»å‹•</button>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <div class="input-group">
                                                          <select id="loopCount{{ pump }}" data-pump="{{ pump }}" style="width: 100px; padding: 10px 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                                  <option value="0" selected>0</option>
                                  <option value="1">1</option>
                                  <option value="2">2</option>
                                  <option value="3">3</option>
                                  <option value="5">5</option>
                                  <option value="10">10</option>
                                  <option value="50">50</option>
                                  <option value="100">100</option>
                                  <option value="1000">1000</option>
                                  <option value="10000">10000</option>
                                  <option value="30000">30000</option>
                                  <option value="custom">ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›...</option>
                              </select>
                            <button type="button" class="btn btn-loop" id="loopBtn{{ pump }}" data-pump="{{ pump }}">ãƒ«ãƒ¼ãƒ—</button>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <div class="input-group">
                            <button type="button" class="btn btn-stop" id="stopBtn{{ pump }}" data-pump="{{ pump }}">åœæ­¢</button>
                            <button type="button" class="btn btn-status" id="statusBtn{{ pump }}" data-pump="{{ pump }}">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</button>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label for="commandDisplay{{ pump }}">é€ä¿¡ã‚³ãƒãƒ³ãƒ‰</label>
                        <textarea id="commandDisplay{{ pump }}" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px; resize: vertical;" readonly placeholder="ã‚³ãƒãƒ³ãƒ‰ãŒé€ä¿¡ã•ã‚Œã‚‹ã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</body>
</html>


