<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シリンジポンプ制御</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; margin: 0; }
        .container { max-width: 1200px; margin: 0 auto; background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: #fff; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin: 0 0 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .content { padding: 30px; }
        .nav-links { text-align: center; margin-bottom: 20px; }
        .nav-links a { display: inline-block; padding: 10px 20px; margin: 0 10px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; text-decoration: none; border-radius: 25px; font-weight: 600; transition: all 0.3s ease; }
        .nav-links a:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4); }
        .card { background: #fff; border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .status { margin-bottom: 20px; }
        .status h3 { margin: 0; }
        .status p { margin: 0; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; background: #28a745; }
        .pump-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .pump-box { border: 2px solid #e0e0e0; padding: 20px; border-radius: 15px; background: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: all 0.3s ease; }
        .pump-box:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        .pump-box h2 { margin: 0 0 15px; color: #333; font-size: 1.5em; text-align: center; }
        .control-group { margin-bottom: 15px; }
        .input-group { display: flex; align-items: center; gap: 10px; flex-wrap: nowrap; }
        .control-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        select { width: 100%; padding: 10px 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; }
        .input-group select { width: auto; min-width: 72px; }
        select:focus { outline: none; border-color: #4facfe; }

        .btn { white-space: nowrap; }
        .muted { color: #666; }
        .placeholder { padding: 30px; text-align: center; color: #666; border: 2px dashed #cfd8dc; border-radius: 12px; background: #fafbfc; }
        .actions { margin-top: 20px; text-align: center; }
        .btn { padding: 12px 24px; border: none; border-radius: 25px; font-size: 1em; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-block; transition: all 0.3s ease; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
        
        /* 各ボタンタイプ別のホバーエフェクト */
        .btn-initialize { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: #fff; }
        .btn-initialize:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 123, 255, 0.4); }
        
        .btn-up { background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); color: #fff; }
        .btn-up:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4); }
        
        .btn-down { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: #fff; }
        .btn-down:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(23, 162, 184, 0.4); }
        
        .btn-loop { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: #fff; }
        .btn-loop:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4); }
        
        .btn-stop { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: #fff; }
        .btn-stop:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(220, 53, 69, 0.4); }
        
        .btn-status { background: linear-gradient(135deg, #6f42c1 0%, #5a2d91 100%); color: #fff; }
        .btn-status:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(111, 66, 193, 0.4); }
        .pump-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .pump-box { border: 2px solid #e0e0e0; padding: 20px; border-radius: 15px; background: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: all 0.3s ease; }
        .pump-box:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        .pump-box h2 { margin: 0 0 15px; color: #333; font-size: 1.5em; text-align: center; }
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        select { width: 100%; padding: 10px 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; }
        select:focus { outline: none; border-color: #4facfe; }
    </style>
    <script>
        // コマンドバイトを表示用にフォーマットする関数
        function formatCommandBytes(commandBytes) {
            if (!commandBytes || commandBytes.length === 0) return '';
            
            let formatted = '';
            for (let i = 0; i < commandBytes.length; i++) {
                const byte = commandBytes[i];
                if (byte === 0x02) {
                    formatted += 'STX ';
                } else if (byte === 0x03) {
                    formatted += 'ETX ';
                } else if (byte >= 32 && byte <= 126) {
                    // 表示可能なASCII文字
                    formatted += String.fromCharCode(byte) + ' ';
                } else {
                    // その他のバイトは16進数で表示
                    formatted += `0x${byte.toString(16).padStart(2, '0').toUpperCase()} `;
                }
            }
            return formatted.trim();
        }

        async function checkStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                const syringeOnline = !!data.syringe_serial_initialized;
                const syringeIndicator = document.getElementById('syringeStatus');
                const syringeText = document.getElementById('syringeStatusText');
                if (syringeOnline) {
                    syringeIndicator.style.background = '#28a745';
                    syringeText.textContent = 'USB2（シリンジポンプ）: オンライン';
                } else {
                    syringeIndicator.style.background = '#dc3545';
                    syringeText.textContent = 'USB2（シリンジポンプ）: オフライン';
                }
            } catch (e) {
                console.error('状態確認に失敗しました', e);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // 状態表示の定期更新
            checkStatus();
            setInterval(checkStatus, 30000);

            // 6台分のアドレス初期化（1..6 をユニークに割当）＋ローカル保存
            const defaultAddresses = {1:1, 2:2, 3:3, 4:4, 5:5, 6:6};
            for (let pump = 1; pump <= 6; pump++) {
                const select = document.getElementById(`addr${pump}`);
                if (!select) continue;
                const key = `syringe_addr_p${pump}`;
                const saved = localStorage.getItem(key);
                let initial = saved ? Number(saved) : defaultAddresses[pump];
                if (initial < 1 || initial > 6 || Number.isNaN(initial)) initial = defaultAddresses[pump];
                select.value = String(initial);
                if (!saved) localStorage.setItem(key, String(initial));
                select.addEventListener('change', () => {
                    localStorage.setItem(key, select.value);
                });
                // 初期化ボタン
                const initBtn = document.getElementById(`initBtn${pump}`);
                if (initBtn) {
                    initBtn.addEventListener('click', async () => {
                        try {
                            initBtn.disabled = true;
                            initBtn.textContent = '送信中...';
                            
                            const address = document.getElementById(`addr${pump}`).value;
                            const response = await fetch(`/api/syringe_pump_control?pump=${pump}&action=initialize&address=${address}`);
                            const data = await response.json();
                            
                            // 成否に関わらず、コマンド内容が返ってきたら表示
                            if (data.command_bytes && data.command_bytes.length > 0) {
                                const commandDisplay = document.getElementById(`commandDisplay${pump}`);
                                if (commandDisplay) {
                                    const commandBytes = new Uint8Array(data.command_bytes);
                                    commandDisplay.value = formatCommandBytes(commandBytes);
                                }
                            }
                            if (!data.success) {
                                console.error(`初期化コマンド送信失敗: ${data.message}`);
                            }
                        } catch (error) {
                            console.error('初期化コマンド送信中にエラーが発生しました:', error);
                        } finally {
                            initBtn.disabled = false;
                            initBtn.textContent = '初期化';
                        }
                    });
                }
                
                // 上移動ステップ数のカスタム入力処理
                const stepsSelect = document.getElementById(`steps${pump}`);
                if (stepsSelect) {
                    stepsSelect.addEventListener('change', () => {
                        if (stepsSelect.value === 'custom') {
                            const customValue = prompt('ステップ数を入力してください:');
                            if (customValue !== null && customValue.trim() !== '') {
                                const numValue = parseInt(customValue);
                                if (!isNaN(numValue) && numValue > 0) {
                                    // カスタム値を新しいoptionとして追加
                                    const newOption = document.createElement('option');
                                    newOption.value = customValue;
                                    newOption.textContent = customValue;
                                    stepsSelect.insertBefore(newOption, stepsSelect.lastElementChild);
                                    stepsSelect.value = customValue;
                                } else {
                                    alert('有効な数値を入力してください');
                                    stepsSelect.value = '3000'; // デフォルト値に戻す
                                }
                            } else {
                                stepsSelect.value = '3000'; // デフォルト値に戻す
                            }
                        }
                    });
                }
                
                // 下移動ステップ数のカスタム入力処理
                const downStepsSelect = document.getElementById(`downSteps${pump}`);
                if (downStepsSelect) {
                    downStepsSelect.addEventListener('change', () => {
                        if (downStepsSelect.value === 'custom') {
                            const customValue = prompt('ステップ数を入力してください:');
                            if (customValue !== null && customValue.trim() !== '') {
                                const numValue = parseInt(customValue);
                                if (!isNaN(numValue) && numValue > 0) {
                                    // カスタム値を新しいoptionとして追加
                                    const newOption = document.createElement('option');
                                    newOption.value = customValue;
                                    newOption.textContent = customValue;
                                    downStepsSelect.insertBefore(newOption, downStepsSelect.lastElementChild);
                                    downStepsSelect.value = customValue;
                                } else {
                                    alert('有効な数値を入力してください');
                                    downStepsSelect.value = '3000'; // デフォルト値に戻す
                                }
                            } else {
                                downStepsSelect.value = '3000'; // デフォルト値に戻す
                            }
                        }
                    });
                }
                
                // ループ数のカスタム入力処理
                const loopCountSelect = document.getElementById(`loopCount${pump}`);
                if (loopCountSelect) {
                    loopCountSelect.addEventListener('change', () => {
                        if (loopCountSelect.value === 'custom') {
                            const customValue = prompt('ループ数を入力してください:');
                            if (customValue !== null && customValue.trim() !== '') {
                                const numValue = parseInt(customValue);
                                if (!isNaN(numValue) && numValue >= 0) {
                                    // カスタム値を新しいoptionとして追加
                                    const newOption = document.createElement('option');
                                    newOption.value = customValue;
                                    newOption.textContent = customValue;
                                    loopCountSelect.insertBefore(newOption, loopCountSelect.lastElementChild);
                                    loopCountSelect.value = customValue;
                                } else {
                                    alert('有効な数値を入力してください（0以上の整数）');
                                    loopCountSelect.value = '0'; // デフォルト値に戻す
                                }
                            } else {
                                loopCountSelect.value = '0'; // デフォルト値に戻す
                            }
                        }
                    });
                }
                
                // 上移動ボタン
                const upBtn = document.getElementById(`upBtn${pump}`);
                if (upBtn) {
                    upBtn.addEventListener('click', async () => {
                        try {
                            upBtn.disabled = true;
                            upBtn.textContent = '送信中...';
                            
                            const steps = document.getElementById(`steps${pump}`).value;
                            const address = document.getElementById(`addr${pump}`).value;
                            const response = await fetch(`/api/syringe_pump_control?pump=${pump}&action=move_up&steps=${steps}&address=${address}`);
                            const data = await response.json();
                            
                            // 成否に関わらず、コマンド内容が返ってきたら表示
                            if (data.command_bytes && data.command_bytes.length > 0) {
                                const commandDisplay = document.getElementById(`commandDisplay${pump}`);
                                if (commandDisplay) {
                                    const commandBytes = new Uint8Array(data.command_bytes);
                                    commandDisplay.value = formatCommandBytes(commandBytes);
                                }
                            }
                            if (!data.success) {
                                console.error(`上移動コマンド送信失敗: ${data.message}`);
                            }
                        } catch (error) {
                            console.error('上移動コマンド送信中にエラーが発生しました:', error);
                        } finally {
                            upBtn.disabled = false;
                            upBtn.textContent = '上移動';
                        }
                    });
                }
                
                // 下移動ボタン
                const downBtn = document.getElementById(`downBtn${pump}`);
                if (downBtn) {
                    downBtn.addEventListener('click', async () => {
                        try {
                            downBtn.disabled = true;
                            downBtn.textContent = '送信中...';
                            
                            const steps = document.getElementById(`downSteps${pump}`).value;
                            const address = document.getElementById(`addr${pump}`).value;
                            const response = await fetch(`/api/syringe_pump_control?pump=${pump}&action=move_down&steps=${steps}&address=${address}`);
                            const data = await response.json();
                            
                            // 成否に関わらず、コマンド内容が返ってきたら表示
                            if (data.command_bytes && data.command_bytes.length > 0) {
                                const commandDisplay = document.getElementById(`commandDisplay${pump}`);
                                if (commandDisplay) {
                                    const commandBytes = new Uint8Array(data.command_bytes);
                                    commandDisplay.value = formatCommandBytes(commandBytes);
                                }
                            }
                            if (!data.success) {
                                console.error(`下移動コマンド送信失敗: ${data.message}`);
                            }
                        } catch (error) {
                            console.error('下移動コマンド送信中にエラーが発生しました:', error);
                        } finally {
                            downBtn.disabled = false;
                            downBtn.textContent = '下移動';
                        }
                    });
                }
                
                // 停止ボタン
                const stopBtn = document.getElementById(`stopBtn${pump}`);
                if (stopBtn) {
                    stopBtn.addEventListener('click', async () => {
                        try {
                            stopBtn.disabled = true;
                            stopBtn.textContent = '送信中...';
                            
                            const address = document.getElementById(`addr${pump}`).value;
                            const response = await fetch(`/api/syringe_pump_control?pump=${pump}&action=stop&address=${address}`);
                            const data = await response.json();
                            
                            // 成否に関わらず、コマンド内容が返ってきたら表示
                            if (data.command_bytes && data.command_bytes.length > 0) {
                                const commandDisplay = document.getElementById(`commandDisplay${pump}`);
                                if (commandDisplay) {
                                    const commandBytes = new Uint8Array(data.command_bytes);
                                    commandDisplay.value = formatCommandBytes(commandBytes);
                                }
                            }
                            if (!data.success) {
                                console.error(`停止コマンド送信失敗: ${data.message}`);
                            }
                        } catch (error) {
                            console.error('停止コマンド送信中にエラーが発生しました:', error);
                        } finally {
                            stopBtn.disabled = false;
                            stopBtn.textContent = '停止';
                        }
                    });
                }
                
                // ステータスボタン
                const statusBtn = document.getElementById(`statusBtn${pump}`);
                if (statusBtn) {
                    statusBtn.addEventListener('click', async () => {
                        try {
                            statusBtn.disabled = true;
                            statusBtn.textContent = '送信中...';
                            
                            const address = document.getElementById(`addr${pump}`).value;
                            const response = await fetch(`/api/syringe_pump_control?pump=${pump}&action=qr&address=${address}`);
                            const data = await response.json();
                            
                            // 成否に関わらず、コマンド内容が返ってきたら表示
                            if (data.command_bytes && data.command_bytes.length > 0) {
                                const commandDisplay = document.getElementById(`commandDisplay${pump}`);
                                if (commandDisplay) {
                                    const commandBytes = new Uint8Array(data.command_bytes);
                                    commandDisplay.value = formatCommandBytes(commandBytes);
                                }
                            }
                            if (!data.success) {
                                console.error(`ステータス確認コマンド送信失敗: ${data.message}`);
                            }
                        } catch (error) {
                            console.error('ステータス確認コマンド送信中にエラーが発生しました:', error);
                        } finally {
                            statusBtn.disabled = false;
                            statusBtn.textContent = 'ステータス';
                        }
                        });
                }
                
                // ループボタン
                const loopBtn = document.getElementById(`loopBtn${pump}`);
                if (loopBtn) {
                    loopBtn.addEventListener('click', async () => {
                        try {
                            loopBtn.disabled = true;
                            loopBtn.textContent = '送信中...';
                            
                            const loopCount = document.getElementById(`loopCount${pump}`).value;
                            const downSteps = document.getElementById(`downSteps${pump}`).value;
                            const upSteps = document.getElementById(`steps${pump}`).value;
                            const address = document.getElementById(`addr${pump}`).value;
                            const response = await fetch(`/api/syringe_pump_control?pump=${pump}&action=loop&loopCount=${loopCount}&downSteps=${downSteps}&steps=${upSteps}&address=${address}`);
                            const data = await response.json();
                            
                            // 成否に関わらず、コマンド内容が返ってきたら表示
                            if (data.command_bytes && data.command_bytes.length > 0) {
                                const commandDisplay = document.getElementById(`commandDisplay${pump}`);
                                if (commandDisplay) {
                                    const commandBytes = new Uint8Array(data.command_bytes);
                                    commandDisplay.value = formatCommandBytes(commandBytes);
                                }
                            }
                            if (!data.success) {
                                console.error(`ループコマンド送信失敗: ${data.message}`);
                            }
                        } catch (error) {
                            console.error('ループコマンド送信中にエラーが発生しました:', error);
                        } finally {
                            loopBtn.disabled = false;
                            loopBtn.textContent = 'ループ';
                        }
                    });
                }
            }
        });
    </script>
    </head>
<body>
    <div class="container">
        <div class="header">
            <h1>💉 シリンジポンプ制御</h1>
        </div>

        <div class="content">
            <div class="nav-links">
                <a href="/">📹 カメラストリーミング</a>
                <a href="/pump_control">🔧 ハイセラポンプ制御</a>
                <a href="/syringe_pump">💉 シリンジポンプ制御</a>
            </div>

            <div class="status">
                <h3>📊 システム状態</h3>
                <p>
                    <span class="status-indicator" id="syringeStatus"></span>
                    <span id="syringeStatusText">COM19（シリンジポンプ）: 確認中...</span>
                </p>
            </div>

            <div class="pump-grid">
                {% for pump in range(1,7) %}
                <div class="pump-box">
                    <h2>シリンジポンプ {{ pump }}</h2>
                    <div class="control-group">
                        <label for="addr{{ pump }}">アドレス</label>
                        <div class="input-group">
                        <select id="addr{{ pump }}" data-pump="{{ pump }}">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                        </select>
                        <button type="button" class="btn btn-initialize" id="initBtn{{ pump }}" data-pump="{{ pump }}">初期化</button>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <div class="input-group">
                            <select id="steps{{ pump }}" data-pump="{{ pump }}" style="width: 100px; padding: 10px 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                                <option value="1000">1000</option>
                                <option value="2000">2000</option>
                                <option value="3000" selected>3000</option>
                                <option value="4000">4000</option>
                                <option value="5000">5000</option>
                                <option value="6000">6000</option>
                                <option value="custom">カスタム入力...</option>
                            </select>
                            <button type="button" class="btn btn-up" id="upBtn{{ pump }}" data-pump="{{ pump }}">上移動</button>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <div class="input-group">
                            <select id="downSteps{{ pump }}" data-pump="{{ pump }}" style="width: 100px; padding: 10px 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                                <option value="1000">1000</option>
                                <option value="2000">2000</option>
                                <option value="3000" selected>3000</option>
                                <option value="4000">4000</option>
                                <option value="5000">5000</option>
                                <option value="6000">6000</option>
                                <option value="custom">カスタム入力...</option>
                            </select>
                            <button type="button" class="btn btn-down" id="downBtn{{ pump }}" data-pump="{{ pump }}">下移動</button>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <div class="input-group">
                                                          <select id="loopCount{{ pump }}" data-pump="{{ pump }}" style="width: 100px; padding: 10px 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                                  <option value="0" selected>0</option>
                                  <option value="1">1</option>
                                  <option value="2">2</option>
                                  <option value="3">3</option>
                                  <option value="5">5</option>
                                  <option value="10">10</option>
                                  <option value="50">50</option>
                                  <option value="100">100</option>
                                  <option value="1000">1000</option>
                                  <option value="10000">10000</option>
                                  <option value="30000">30000</option>
                                  <option value="custom">カスタム入力...</option>
                              </select>
                            <button type="button" class="btn btn-loop" id="loopBtn{{ pump }}" data-pump="{{ pump }}">ループ</button>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <div class="input-group">
                            <button type="button" class="btn btn-stop" id="stopBtn{{ pump }}" data-pump="{{ pump }}">停止</button>
                            <button type="button" class="btn btn-status" id="statusBtn{{ pump }}" data-pump="{{ pump }}">ステータス</button>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label for="commandDisplay{{ pump }}">送信コマンド</label>
                        <textarea id="commandDisplay{{ pump }}" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px; resize: vertical;" readonly placeholder="コマンドが送信されるとここに表示されます"></textarea>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</body>
</html>


